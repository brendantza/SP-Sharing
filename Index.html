<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SharePoint Sharing Report</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- MSAL.js library for authentication -->
    <script src="https://alcdn.msauth.net/browser/2.14.2/js/msal-browser.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
            transition: opacity 0.3s ease;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            max-width: 500px;
            width: 90%;
            transform: scale(0.95);
            transition: transform 0.3s ease;
        }
        .modal-backdrop:not(.hidden) .modal-content {
            transform: scale(1);
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="app" class="container mx-auto p-4 md:p-8">
        <header class="mb-8 flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-bold text-gray-900">SharePoint Sharing Report</h1>
                <p id="userInfo" class="text-gray-600 mt-1">View and manage shared files and folders.</p>
            </div>
            <button id="logoutBtn" class="hidden bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg transition duration-300">
                Sign Out
            </button>
        </header>

        <!-- Connection Section -->
        <div id="connectionSection" class="bg-white p-6 rounded-lg shadow-md text-center">
            <h2 class="text-xl font-semibold mb-4">Connect to SharePoint</h2>
            <p class="mb-6 text-gray-600">To generate the report, please sign in with your Microsoft 365 account.</p>
            <button id="connectBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg transition duration-300">
                Sign In
            </button>
        </div>
        
        <!-- Loading Section -->
        <div id="loadingSection" class="hidden text-center bg-white p-6 rounded-lg shadow-md">
            <div class="loader mx-auto"></div>
            <p id="loadingStatus" class="mt-4 text-gray-600">Fetching data from SharePoint...</p>
        </div>

        <!-- Report Section (Initially Hidden) -->
        <main id="reportSection" class="hidden">
            <div class="bg-white rounded-lg shadow-md">
                <div id="bulkActionsToolbar" class="p-4 border-b border-gray-200 bg-gray-50 rounded-t-lg hidden">
                     <!-- Bulk actions UI here -->
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left text-gray-600">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-100">
                            <tr>
                                <th scope="col" class="p-4"><input type="checkbox" id="selectAllCheckbox"></th>
                                <th scope="col" class="px-6 py-3">Item Name</th>
                                <th scope="col" class="px-6 py-3">Shared With</th>
                                <th scope="col" class="px-6 py-3">Shared On</th>
                                <th scope="col" class="px-6 py-3">Expiration Date</th>
                                <th scope="col" class="px-6 py-3 text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="sharingReportBody">
                            <!-- Data will be injected here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals (Confirmation and Date Picker) -->
    <div id="confirmationModal" class="modal-backdrop hidden"> <!-- Modal content --> </div>
    <div id="datePickerModal" class="modal-backdrop hidden"> <!-- Modal content --> </div>


    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- DOM Elements ---
        const connectBtn = document.getElementById('connectBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const connectionSection = document.getElementById('connectionSection');
        const loadingSection = document.getElementById('loadingSection');
        const loadingStatus = document.getElementById('loadingStatus');
        const reportSection = document.getElementById('reportSection');
        const sharingReportBody = document.getElementById('sharingReportBody');
        const userInfo = document.getElementById('userInfo');

        // --- MSAL Configuration ---
        const msalConfig = {
            auth: {
                // IMPORTANT: Replace with your Azure App Registration's Application (client) ID
                clientId: "YOUR_CLIENT_ID_HERE", 
                authority: "https://login.microsoftonline.com/common", // Multi-tenant support
                redirectUri: window.location.origin,
            },
            cache: {
                cacheLocation: "sessionStorage",
                storeAuthStateInCookie: false,
            }
        };

        const msalInstance = new msal.PublicClientApplication(msalConfig);

        // Define the permissions (scopes) your app needs from Microsoft Graph
        const loginRequest = {
            scopes: ["User.Read", "Sites.Read.All", "Files.ReadWrite.All"]
        };

        // --- Authentication Logic ---
        const signIn = async () => {
            try {
                await msalInstance.loginPopup(loginRequest);
                const account = msalInstance.getActiveAccount();
                if (account) {
                    updateUIAfterLogin(account);
                    fetchSharedItems();
                }
            } catch (error) {
                console.error("Login failed:", error);
                alert("Login failed. Please check the console for details.");
            }
        };

        const signOut = () => {
            msalInstance.logoutPopup({
                postLogoutRedirectUri: window.location.origin,
                mainWindowRedirectUri: window.location.origin
            });
        };

        const getToken = async () => {
            const account = msalInstance.getActiveAccount();
            if (!account) {
                throw new Error("User account not found.");
            }
            const tokenRequest = {
                scopes: loginRequest.scopes,
                account: account
            };
            try {
                const response = await msalInstance.acquireTokenSilent(tokenRequest);
                return response.accessToken;
            } catch (error) {
                if (error instanceof msal.InteractionRequiredAuthError) {
                    // Fallback to interactive token acquisition if silent fails
                    return msalInstance.acquireTokenPopup(tokenRequest).then(response => response.accessToken);
                }
                console.error("Token acquisition failed:", error);
            }
        };

        // --- Microsoft Graph API Logic ---
        const callGraphApi = async (endpoint, method = 'GET', body = null) => {
            const token = await getToken();
            if (!token) {
                console.error("Could not acquire access token.");
                return;
            }
            const headers = new Headers();
            headers.append("Authorization", `Bearer ${token}`);
            if (body) {
                headers.append("Content-Type", "application/json");
            }

            const options = { method, headers, body: body ? JSON.stringify(body) : null };

            const response = await fetch(endpoint, options);
            if (!response.ok) {
                const error = await response.json();
                throw new Error(`Graph API call failed: ${error.error.message}`);
            }
            if (response.status === 204) { // No Content for DELETE/PATCH
                return null;
            }
            return response.json();
        };

        const fetchSharedItems = async () => {
            reportSection.classList.add('hidden');
            loadingSection.classList.remove('hidden');
            sharingReportBody.innerHTML = '<tr><td colspan="6" class="text-center p-8">No shared items found or still loading...</td></tr>';

            try {
                loadingStatus.textContent = "Discovering SharePoint sites...";
                const sites = await callGraphApi("https://graph.microsoft.com/v1.0/sites?search=*");
                
                let allSharedItems = [];

                for (const site of sites.value) {
                    loadingStatus.textContent = `Scanning site: ${site.displayName}...`;
                    try {
                        const drive = await callGraphApi(`https://graph.microsoft.com/v1.0/sites/${site.id}/drive`);
                        // Search for all items in the drive and expand their permissions
                        const itemsWithPermissions = await callGraphApi(`https://graph.microsoft.com/v1.0/drives/${drive.id}/root/search(q='')?select=id,name,webUrl,createdDateTime,parentReference&expand=permissions`);
                        
                        itemsWithPermissions.value.forEach(item => {
                            if (item.permissions) {
                                item.permissions.forEach(permission => {
                                    // Filter for actual sharing permissions (not owner/default roles)
                                    if (permission.link || (permission.roles && !permission.roles.includes('owner'))) {
                                        allSharedItems.push(processPermission(item, permission, drive.id));
                                    }
                                });
                            }
                        });
                    } catch (driveError) {
                        console.warn(`Could not access drive for site ${site.displayName}. Skipping.`, driveError);
                    }
                }
                
                renderTable(allSharedItems);

            } catch (error) {
                console.error(error);
                alert("Failed to fetch SharePoint data. Check console for details.");
            } finally {
                loadingSection.classList.add('hidden');
                reportSection.classList.remove('hidden');
            }
        };
        
        const expirePermission = async (driveId, itemId, permissionId) => {
            try {
                await callGraphApi(`https://graph.microsoft.com/v1.0/drives/${driveId}/items/${itemId}/permissions/${permissionId}`, 'DELETE');
                alert("Share expired successfully!");
                fetchSharedItems(); // Refresh the list
            } catch (error) {
                alert(`Failed to expire share: ${error.message}`);
            }
        };

        const setExpirationDate = async (driveId, itemId, permissionId, expirationDate) => {
             try {
                const body = { expirationDateTime: new Date(expirationDate).toISOString() };
                await callGraphApi(`https://graph.microsoft.com/v1.0/drives/${driveId}/items/${itemId}/permissions/${permissionId}`, 'PATCH', body);
                alert("Expiration date set successfully!");
                fetchSharedItems(); // Refresh the list
            } catch (error) {
                alert(`Failed to set expiration date: ${error.message}. Note: This is typically only supported for sharing links.`);
            }
        };


        // --- UI & Data Processing ---
        const processPermission = (item, permission, driveId) => {
            let sharedWith = "Unknown";
            if (permission.link) {
                sharedWith = `Link (${permission.link.scope})`;
            } else if (permission.grantedToIdentitiesV2 && permission.grantedToIdentitiesV2.length > 0) {
                sharedWith = permission.grantedToIdentitiesV2.map(grantee => grantee.user?.displayName || grantee.user?.email || "Group").join(', ');
            }
            
            return {
                id: `${driveId}|${item.id}|${permission.id}`, // Composite ID
                driveId: driveId,
                itemId: item.id,
                permissionId: permission.id,
                name: item.parentReference.path.replace('/drives/' + driveId + '/root:', '') + '/' + item.name,
                sharedWith: sharedWith,
                sharedOn: permission.invitation ? new Date(permission.invitation.invitedDateTime).toLocaleDateString() : 'N/A',
                expires: permission.expirationDateTime ? new Date(permission.expirationDateTime).toLocaleDateString() : null,
                isLink: !!permission.link
            };
        };

        const renderTable = (items) => {
            sharingReportBody.innerHTML = '';
            if (items.length === 0) {
                sharingReportBody.innerHTML = '<tr><td colspan="6" class="text-center p-8">No shared items found.</td></tr>';
                return;
            }
            items.forEach(item => {
                const row = document.createElement('tr');
                row.className = 'bg-white border-b hover:bg-gray-50';
                const expirationHtml = item.expires
                    ? `<span class="bg-green-100 text-green-800 text-xs font-medium mr-2 px-2.5 py-0.5 rounded-full">${item.expires}</span>`
                    : `<span class="bg-yellow-100 text-yellow-800 text-xs font-medium mr-2 px-2.5 py-0.5 rounded-full">No Expiration</span>`;
                
                // Simplified action buttons for clarity
                const setExpireBtn = item.isLink ? `<button data-id="${item.id}" class="set-expire-btn font-medium text-blue-600 hover:underline mr-3">Set Expiration</button>` : '';

                row.innerHTML = `
                    <td class="w-4 p-4"><input type="checkbox" data-id="${item.id}" class="row-checkbox"></td>
                    <td class="px-6 py-4 font-medium text-gray-900">${item.name}</td>
                    <td class="px-6 py-4">${item.sharedWith}</td>
                    <td class="px-6 py-4">${item.sharedOn}</td>
                    <td class="px-6 py-4">${expirationHtml}</td>
                    <td class="px-6 py-4 text-center whitespace-nowrap">
                        ${setExpireBtn}
                        <button data-id="${item.id}" class="expire-btn font-medium text-red-600 hover:underline">Expire Now</button>
                    </td>
                `;
                sharingReportBody.appendChild(row);

                // Add event listeners for the new buttons
                row.querySelector('.expire-btn')?.addEventListener('click', () => {
                    if (confirm(`Are you sure you want to expire the share for "${item.name}"?`)) {
                        expirePermission(item.driveId, item.itemId, item.permissionId);
                    }
                });
                row.querySelector('.set-expire-btn')?.addEventListener('click', () => {
                    const newDate = prompt(`Set new expiration date for "${item.name}" (YYYY-MM-DD):`, new Date().toISOString().split('T')[0]);
                    if (newDate) {
                        setExpirationDate(item.driveId, item.itemId, item.permissionId, newDate);
                    }
                });
            });
        };
        
        const updateUIAfterLogin = (account) => {
            connectionSection.classList.add('hidden');
            logoutBtn.classList.remove('hidden');
            userInfo.textContent = `Signed in as: ${account.username}`;
        };

        // --- Initial Load ---
        msalInstance.handleRedirectPromise().then(() => {
            const account = msalInstance.getActiveAccount();
            if (account) {
                updateUIAfterLogin(account);
                fetchSharedItems();
            }
        });

        // --- Event Listeners ---
        connectBtn.addEventListener('click', signIn);
        logoutBtn.addEventListener('click', signOut);
    });
    </script>
</body>
</html>
